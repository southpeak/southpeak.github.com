<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="原文由Colin Eberhardt发表于raywenderlich，ReactiveCocoa Tutorial – The Definitive Introduction: Part 1/2
在编写iOS代码时，我们的大部分代码都是在响应一些事件：按钮点击、接收网络消息、属性变化等等。但是这些事件在代码中的表现形式却不一样：如target-action、代理方法、KVO、回调或其它。React">
<meta property="og:type" content="article">
<meta property="og:title" content="ReactiveCocoa Tutorial – The Definitive Introduction: Part 1/2">
<meta property="og:url" content="http://southpeak.github.io/2014/08/02/reactivecocoa-tutorial-the-definitive-introduction-1/index.html">
<meta property="og:site_name" content="南峰子的技术博客">
<meta property="og:description" content="原文由Colin Eberhardt发表于raywenderlich，ReactiveCocoa Tutorial – The Definitive Introduction: Part 1/2
在编写iOS代码时，我们的大部分代码都是在响应一些事件：按钮点击、接收网络消息、属性变化等等。但是这些事件在代码中的表现形式却不一样：如target-action、代理方法、KVO、回调或其它。React">
<meta property="og:image" content="http://cdn4.raywenderlich.com/wp-content/uploads/2014/01/ReactivePlaygroundStarter.jpg">
<meta property="og:image" content="http://cdn3.raywenderlich.com/wp-content/uploads/2014/01/AddedCocoaPods.png">
<meta property="og:image" content="http://cdn4.raywenderlich.com/wp-content/uploads/2014/01/FilterPipeline.png">
<meta property="og:image" content="http://cdn2.raywenderlich.com/wp-content/uploads/2014/01/FilterAndMapPipeline.png">
<meta property="og:image" content="http://cdn5.raywenderlich.com/wp-content/uploads/2014/01/TextFieldValidPipeline.png">
<meta property="og:image" content="http://cdn3.raywenderlich.com/wp-content/uploads/2014/01/CombinePipeline.png">
<meta property="og:image" content="http://cdn4.raywenderlich.com/wp-content/uploads/2014/01/SignalOfSignals.png">
<meta property="og:image" content="http://cdn4.raywenderlich.com/wp-content/uploads/2014/01/ReactivePlaygroundStarter.jpg">
<meta property="og:image" content="http://cdn3.raywenderlich.com/wp-content/uploads/2014/01/SideEffects.png">
<meta property="og:updated_time" content="2016-08-27T05:29:25.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ReactiveCocoa Tutorial – The Definitive Introduction: Part 1/2">
<meta name="twitter:description" content="原文由Colin Eberhardt发表于raywenderlich，ReactiveCocoa Tutorial – The Definitive Introduction: Part 1/2
在编写iOS代码时，我们的大部分代码都是在响应一些事件：按钮点击、接收网络消息、属性变化等等。但是这些事件在代码中的表现形式却不一样：如target-action、代理方法、KVO、回调或其它。React">
<meta name="twitter:image" content="http://cdn4.raywenderlich.com/wp-content/uploads/2014/01/ReactivePlaygroundStarter.jpg">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://southpeak.github.io/2014/08/02/reactivecocoa-tutorial-the-definitive-introduction-1/"/>

  <title> ReactiveCocoa Tutorial – The Definitive Introduction: Part 1/2 | 南峰子的技术博客 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-68856508-1', 'auto');
  ga('send', 'pageview');
</script>







  <div style="display: none;">
    <script src="http://s95.cnzz.com/z_stat.php?id=1000523916&web_id=1000523916" language="JavaScript"></script>
  </div>





  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">南峰子的技术博客</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">攀登，一步一个脚印，方能知其乐</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-techset">
          <a href="/categories/techset" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-fighter-jet"></i> <br />
            
            知识小集
          </a>
        </li>
      
        
        <li class="menu-item menu-item-swift">
          <a href="/categories/swift" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-space-shuttle"></i> <br />
            
            Swift
          </a>
        </li>
      
        
        <li class="menu-item menu-item-objectivec">
          <a href="/categories/objectivec" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-taxi"></i> <br />
            
            Objective-C
          </a>
        </li>
      
        
        <li class="menu-item menu-item-cocoa">
          <a href="/categories/cocoa" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-subway"></i> <br />
            
            Cocoa
          </a>
        </li>
      
        
        <li class="menu-item menu-item-translate">
          <a href="/categories/translate" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-rocket"></i> <br />
            
            翻译
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sourcecode">
          <a href="/categories/sourcecode" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-train"></i> <br />
            
            源码分析
          </a>
        </li>
      
        
        <li class="menu-item menu-item-something">
          <a href="/categories/something" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-bicycle"></i> <br />
            
            杂项
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                ReactiveCocoa Tutorial – The Definitive Introduction: Part 1/2
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2014-08-02T23:03:12+08:00" content="2014-08-02">
              2014-08-02
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/translate/" itemprop="url" rel="index">
                    <span itemprop="name">翻译</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>原文由<code>Colin Eberhardt</code>发表于<code>raywenderlich</code>，<a href="http://www.raywenderlich.com/62699/reactivecocoa-tutorial-pt1" target="_blank" rel="external">ReactiveCocoa Tutorial – The Definitive Introduction: Part 1/2</a></p>
<p>在编写<code>iOS</code>代码时，我们的大部分代码都是在响应一些事件：按钮点击、接收网络消息、属性变化等等。但是这些事件在代码中的表现形式却不一样：如<code>target-action</code>、代理方法、<code>KVO</code>、回调或其它。<code>ReactiveCocoa</code>的目的就是定义一个统一的事件处理接口，这样它们可以非常简单地进行链接、过滤和组合。</p>
<p><code>ReactiveCocoa</code>结合了一些编程模式：</p>
<ol>
<li>函数式编程：利用高阶函数，即将函数作为其它函数的参数。</li>
<li>响应式编程：关注于数据流及变化的传播。</li>
</ol>
<p>基于以上两点，<code>ReactiveCocoa</code>被当成是函数响应编程(<code>Functional Reactive Programming, FRP</code>)框架。我们将在下面以实例来看看<code>ReactiveCocoa</code>的实用价值。</p>
<h2 id="Reactive-Playground实例"><a href="#Reactive-Playground实例" class="headerlink" title="Reactive Playground实例"></a>Reactive Playground实例</h2><p>虽然这是一篇指南性质的文章，但我们将以一个简单的实例来介绍<code>ReactiveCocoa</code>。可以在<a href="http://cdn2.raywenderlich.com/wp-content/uploads/2014/01/ReactivePlayground-Starter.zip" target="_blank" rel="external">这里</a>下载源代码，然后编译并运行以确保程序可以运行。</p>
<p><code>ReactivePlayground</code>是个非常简单的应用，只有一个用户登录界面。只需要提供正确的用户名及密码，就可以显示一幅可爱的小猫的图片。如下图所示：</p>
<p><img src="http://cdn4.raywenderlich.com/wp-content/uploads/2014/01/ReactivePlaygroundStarter.jpg" alt="image"></p>
<p>这个工程很简单，所以花几分钟来熟悉一下这个工程。打开<code>RWViewController.m</code>，可以快速查找一下如何设置<code>Sign in</code>按钮可用的代码，以及显示/隐藏<code>signInFailure Label</code>的规则。在简单的实现中，我们能快速定位这些问题，但如果实现很复杂，那可能需要花一些时间来分析代码。</p>
<p>现在，我们有了<code>ReactiveCocoa</code>，它能让代码变得更清晰。来看看它是怎么做到的吧。</p>
<h2 id="添加ReactiveCocoa框架"><a href="#添加ReactiveCocoa框架" class="headerlink" title="添加ReactiveCocoa框架"></a>添加ReactiveCocoa框架</h2><p>添加<code>ReactiveCocoa</code>框架到我们工程的最简单的方法是使用<code>Cocoapods</code>。我们先关闭<code>ReactivePlayground</code>工程。<code>Cocoapods</code>会创建一个<code>Xcode workspace</code>，它会替代我们的原始工程文件。</p>
<p>首先创建一个名为<code>Podfile</code>的空文件，打开并添加如下信息：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">platform :ios, '6.0'</div><div class="line">inhibit_all_warnings!</div><div class="line">xcodeproj 'RWReactivePlayground'</div><div class="line"></div><div class="line">target :RWReactivePlayground do</div><div class="line">    pod 'ReactiveCocoa', '~&gt; 2.3.1'</div><div class="line">end</div><div class="line"></div><div class="line">post_install do |installer|</div><div class="line">installer.project.targets.each do |target|</div><div class="line">puts "#&#123;target.name&#125;"</div><div class="line">end</div><div class="line">end</div></pre></td></tr></table></figure>
<p>配置完成后保存文件，打开终端并转到工程所在目录，然后输入以下命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pod install</div></pre></td></tr></table></figure>
<p>然后终端会有如下输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Analyzing dependencies</div><div class="line">Downloading dependencies</div><div class="line">Installing ReactiveCocoa (2.3.1)</div><div class="line">Generating Pods project</div><div class="line">Pods-RWReactivePlayground-ReactiveCocoa</div><div class="line">Pods-RWReactivePlayground</div><div class="line">Integrating client project</div><div class="line"></div><div class="line">[!] From now on use `RWReactivePlayground.xcworkspace`.</div></pre></td></tr></table></figure>
<p>这表示已经下载了<code>ReactiveCocoa</code>框架，同时<code>Cocoapods</code>创建了一个<code>Xcode workspace</code>，同时将框架整合到了我们的工程中。打开新生成的<code>workspace</code>文件(<code>RWReactivePlayground.xcworkspace</code>)，将看到如下的工程结构：</p>
<p><img src="http://cdn3.raywenderlich.com/wp-content/uploads/2014/01/AddedCocoaPods.png" alt="image"></p>
<p>我们看到有一个命名为<code>ReactivePlayground</code>的工程，这实际上是我们的初始工程，它依赖于<code>Pods</code>工程。做完这一切后，我们就可以开始玩了，哈哈。</p>
<h2 id="Time-to-Play"><a href="#Time-to-Play" class="headerlink" title="Time to Play"></a>Time to Play</h2><p>如上所述，<code>ReactiveCocoa</code>提供了一个标准的接口来处理不同的事件流。在<code>ReactiveCocoa</code>中，这些被统一称为信号，由<code>RACSignal</code>类表示。</p>
<p>打开程序的初始视图控制器<code>RWViewController.m</code>文件，在文件头部导入以下头文件：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#import <span class="meta-string">&lt;ReactiveCocoa/ReactiveCocoa.h&gt;</span></span></div></pre></td></tr></table></figure>
<p>我们暂时先不替换原来的代码，先看看如何使用<code>ReactiveCocoa</code>。在<code>viewDidLoad</code>方法中加入如下代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[<span class="keyword">self</span>.usernameTextField.rac_textSignal subscribeNext:^(<span class="keyword">id</span> x) &#123;</div><div class="line"></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, x);</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<p>运行程序并在用户名输入框中键入”<code>reactive cocoa</code>“，我们可以看到控制台会有如下输出：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">32</span>:<span class="number">30.890</span> RWReactivePlayground[<span class="number">9191</span>:<span class="number">60</span>b] r</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">32</span>:<span class="number">32.007</span> RWReactivePlayground[<span class="number">9191</span>:<span class="number">60</span>b] re</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">32</span>:<span class="number">32.289</span> RWReactivePlayground[<span class="number">9191</span>:<span class="number">60</span>b] rea</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">32</span>:<span class="number">33.990</span> RWReactivePlayground[<span class="number">9191</span>:<span class="number">60</span>b] reac</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">32</span>:<span class="number">34.889</span> RWReactivePlayground[<span class="number">9191</span>:<span class="number">60</span>b] react</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">32</span>:<span class="number">35.557</span> RWReactivePlayground[<span class="number">9191</span>:<span class="number">60</span>b] reacti</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">32</span>:<span class="number">36.022</span> RWReactivePlayground[<span class="number">9191</span>:<span class="number">60</span>b] reactiv</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">32</span>:<span class="number">36.505</span> RWReactivePlayground[<span class="number">9191</span>:<span class="number">60</span>b] reactive</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">32</span>:<span class="number">42.328</span> RWReactivePlayground[<span class="number">9191</span>:<span class="number">60</span>b] reactive </div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">32</span>:<span class="number">47.223</span> RWReactivePlayground[<span class="number">9191</span>:<span class="number">60</span>b] reactive c</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">32</span>:<span class="number">47.794</span> RWReactivePlayground[<span class="number">9191</span>:<span class="number">60</span>b] reactive co</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">32</span>:<span class="number">48.191</span> RWReactivePlayground[<span class="number">9191</span>:<span class="number">60</span>b] reactive coc</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">32</span>:<span class="number">48.657</span> RWReactivePlayground[<span class="number">9191</span>:<span class="number">60</span>b] reactive coco</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">32</span>:<span class="number">49.141</span> RWReactivePlayground[<span class="number">9191</span>:<span class="number">60</span>b] reactive cocoa</div></pre></td></tr></table></figure>
<p>我们可以看到，每次在<code>text field</code>中输入时，都会执行<code>block</code>中的代码。没有<code>target-action</code>，没有代理，只有信号与<code>block</code>。是不是很棒？</p>
<p><code>ReactiveCocoa</code>信号发送一个事件流到它们的订阅者中。我们需要知道三种类型的事件：<code>next</code>, <code>error</code>和<code>completed</code>。一个信号可能由于<code>error</code>事件或<code>completed</code>事件而终止，在此之前它会发送很多个<code>next</code>事件。在这一部分中，我们将重点关注<code>next</code>事件。在学习关于<code>error</code>和<code>completed</code>事件前，请仔细阅读第二部分。</p>
<p><code>RACSignal</code>有许多方法用于订阅这些不同的事件类型。每个方法会有一个或多个<code>block</code>，每个<code>block</code>执行不同的逻辑处理。在上面这个例子中，我们看到<code>subscribeNext:</code>方法提供了一个响应<code>next</code>事件的<code>block</code>。</p>
<p><code>ReactiveCocoa</code>框架通过类别来为大部分标准<code>UIKit</code>控件添加信号，以便这些控件可以添加其相应事件的订阅，如上面的<code>UITextField</code>包含了<code>rac_textSignal</code>属性。</p>
<p>理论讲得差不多了，我们继续吧！！！</p>
<p><code>ReactiveCocoa</code>有大量的操作右用于处理事件流。例如，如果我们只对长度大于<code>3</code>的用户名感兴趣，则我们可以使用<code>filter</code>操作。在<code>viewDidLoad</code>中更新我们的代码如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[[<span class="keyword">self</span>.usernameTextField.rac_textSignal filter:^<span class="built_in">BOOL</span>(<span class="keyword">id</span> value) &#123;</div><div class="line">    <span class="built_in">NSString</span> *text = value;</div><div class="line">    <span class="keyword">return</span> text.length &gt; <span class="number">3</span>;</div><div class="line">&#125;] subscribeNext:^(<span class="keyword">id</span> x) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, x);</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<p>运行并在用户名输入框中输入<code>&quot;reactive cocoa&quot;</code>，我们可以看到控制台会有如下输出：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">13.558</span> RWReactivePlayground[<span class="number">9249</span>:<span class="number">60</span>b] reac</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">15.960</span> RWReactivePlayground[<span class="number">9249</span>:<span class="number">60</span>b] react</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">16.589</span> RWReactivePlayground[<span class="number">9249</span>:<span class="number">60</span>b] reacti</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">17.158</span> RWReactivePlayground[<span class="number">9249</span>:<span class="number">60</span>b] reactiv</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">17.807</span> RWReactivePlayground[<span class="number">9249</span>:<span class="number">60</span>b] reactive</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">18.674</span> RWReactivePlayground[<span class="number">9249</span>:<span class="number">60</span>b] reactive </div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">19.176</span> RWReactivePlayground[<span class="number">9249</span>:<span class="number">60</span>b] reactive c</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">19.710</span> RWReactivePlayground[<span class="number">9249</span>:<span class="number">60</span>b] reactive co</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">20.057</span> RWReactivePlayground[<span class="number">9249</span>:<span class="number">60</span>b] reactive coc</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">20.530</span> RWReactivePlayground[<span class="number">9249</span>:<span class="number">60</span>b] reactive coco</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">20.978</span> RWReactivePlayground[<span class="number">9249</span>:<span class="number">60</span>b] reactive cocoa</div></pre></td></tr></table></figure>
<p>可以看到当长度小于<code>3</code>时，并不执行后续的操作。通过这种方式，我们创建了一个简单的管道。这就是响应式编程的实质，我们将我们程序的功能表示为数据流的形式。我们可以将上述调用表示为以下图例：</p>
<p><img src="http://cdn4.raywenderlich.com/wp-content/uploads/2014/01/FilterPipeline.png" alt="image"></p>
<p>从上图中我们可以看到<code>rac_textSignal</code>是事件的初始源头。通过<code>filter</code>的数据流只有在其长度大于3时，才会被传递到下一处理流程中。管道的最后一步是<code>subscribeNext:</code>，在这个<code>block</code>中，我们记录日志。</p>
<p>在这里需要注意的是<code>filter</code>操作的输出仍然是一个<code>RACSignal</code>对象。我们可以将上面这段管道处理拆分成如下代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">RACSignal *usernameSourceSignal = <span class="keyword">self</span>.usernameTextField.rac_textSignal;</div><div class="line"></div><div class="line">RACSignal *filteredUsername = [usernameSourceSignal filter:^<span class="built_in">BOOL</span>(<span class="keyword">id</span> value) &#123;</div><div class="line"></div><div class="line">    <span class="built_in">NSString</span> *text = value;</div><div class="line">    <span class="keyword">return</span> text.length &gt; <span class="number">3</span>;</div><div class="line">&#125;];</div><div class="line"></div><div class="line">[filteredUsername subscribeNext:^(<span class="keyword">id</span> x) &#123;</div><div class="line"></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, x);</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<p>因为<code>RACSignal</code>对象的每个操作都返回一个<code>RACSignal</code>对象，所以我们不需要使用变量就可以构建一个管道。</p>
<h2 id="事件是什么"><a href="#事件是什么" class="headerlink" title="事件是什么"></a>事件是什么</h2><p>目前为止，我们已经描述了<code>3</code>种不同的事件类型，但还没有深入这些事件的结构。有趣的是，事件可以包含任何东西。为了证明这一点，我们在上面的管道中加入另一个操作。更新我们的代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[[[<span class="keyword">self</span>.usernameTextField.rac_textSignal map:^<span class="keyword">id</span>(<span class="built_in">NSString</span> *text) &#123;</div><div class="line">    <span class="keyword">return</span> @(text.length);</div><div class="line"> &#125;]</div><div class="line"> filter:^<span class="built_in">BOOL</span>(<span class="built_in">NSNumber</span> *length) &#123;</div><div class="line">     <span class="keyword">return</span> [length intValue] &gt; <span class="number">3</span>;</div><div class="line"> &#125;]</div><div class="line"> subscribeNext:^(<span class="keyword">id</span> x) &#123;</div><div class="line">     <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>, x);</div><div class="line"> &#125;];</div></pre></td></tr></table></figure>
<p>编译并运行，我们会发现控制台输出如下信息：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">47.652</span> RWReactivePlayground[<span class="number">9321</span>:<span class="number">60</span>b] <span class="number">4</span></div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">47.819</span> RWReactivePlayground[<span class="number">9321</span>:<span class="number">60</span>b] <span class="number">5</span></div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">47.985</span> RWReactivePlayground[<span class="number">9321</span>:<span class="number">60</span>b] <span class="number">6</span></div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">48.134</span> RWReactivePlayground[<span class="number">9321</span>:<span class="number">60</span>b] <span class="number">7</span></div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">48.284</span> RWReactivePlayground[<span class="number">9321</span>:<span class="number">60</span>b] <span class="number">8</span></div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">48.417</span> RWReactivePlayground[<span class="number">9321</span>:<span class="number">60</span>b] <span class="number">9</span></div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">48.583</span> RWReactivePlayground[<span class="number">9321</span>:<span class="number">60</span>b] <span class="number">10</span></div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">48.734</span> RWReactivePlayground[<span class="number">9321</span>:<span class="number">60</span>b] <span class="number">11</span></div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">48.883</span> RWReactivePlayground[<span class="number">9321</span>:<span class="number">60</span>b] <span class="number">12</span></div></pre></td></tr></table></figure>
<p>新添加的<code>map</code>操作使用提供的<code>block</code>来转换事件数据。对于收到的每一个<code>next</code>事件，都会运行给定的<code>block</code>，并将返回值作为<code>next</code>事件发送。在上面的代码中，<code>map</code>操作获取一个<code>NSString</code>输入，并将其映射为一个<code>NSNumber</code>对象，并返回。下图演示了这个管道处理：</p>
<p><img src="http://cdn2.raywenderlich.com/wp-content/uploads/2014/01/FilterAndMapPipeline.png" alt="image"></p>
<p>我们可以看到，<code>map</code>操作后的每一步接收的都是一个<code>NSNumber</code>对象。我们可以使用<code>map</code>操作来转换我们想要的数据，只需要它是一个对象。</p>
<p>OK，是时候修改<code>ReactivePlayground</code>应用的代码了。</p>
<h2 id="创建有效的状态信号"><a href="#创建有效的状态信号" class="headerlink" title="创建有效的状态信号"></a>创建有效的状态信号</h2><p>我们要做的第一件事就是创建一对信号来校验用户名与密码的输入是否有效。添加如下代码到<code>RWViewController.m</code>的<code>viewDidLoad</code>中。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">RACSignal *validUsernameSignal = [<span class="keyword">self</span>.usernameTextField.rac_textSignal map:^<span class="keyword">id</span>(<span class="built_in">NSString</span> *text) &#123;</div><div class="line">    <span class="keyword">return</span> @([<span class="keyword">self</span> isValidUsername:text]);</div><div class="line">&#125;];</div><div class="line"></div><div class="line">RACSignal *validPasswordSignal = [<span class="keyword">self</span>.passwordTextField.rac_textSignal map:^<span class="keyword">id</span>(<span class="built_in">NSString</span> *text) &#123;</div><div class="line">    <span class="keyword">return</span> @([<span class="keyword">self</span> isValidPassword:text]);</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<p>我们使用将<code>map</code>操作应用于文本输入框的<code>rac_textSignal</code>，输出是一个<code>NSNumber</code>对象。接着将转换这些信号，以便其可以为文本输入框提供一个合适的背影颜色。我们可以订阅这个信号并使用其结果来更新文本输入框的颜色。可以如下操作：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[[validPasswordSignal map:^<span class="keyword">id</span>(<span class="built_in">NSNumber</span> *passwordValid) &#123;</div><div class="line">    <span class="keyword">return</span> [passwordValid boolValue] ? [<span class="built_in">UIColor</span> clearColor] : [<span class="built_in">UIColor</span> yellowColor];</div><div class="line">&#125;] subscribeNext:^(<span class="built_in">UIColor</span> *color) &#123;</div><div class="line">    <span class="keyword">self</span>.passwordTextField.backgroundColor = color;</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<p>从概念上讲，我们将信号的输出值赋值给文本输入框的<code>backgroundColor</code>属性。但是这段代码有点糟糕。我们可以以另外一种方式来做相同的处理。这得益于<code>ReactiveCocoa</code>定义的一些宏。如下代码所示：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">RAC(<span class="keyword">self</span>.passwordTextField, backgroundColor) = [validPasswordSignal map:^<span class="keyword">id</span>(<span class="built_in">NSNumber</span> *passwordValid) &#123;</div><div class="line">    <span class="keyword">return</span> [passwordValid boolValue] ? [<span class="built_in">UIColor</span> clearColor] : [<span class="built_in">UIColor</span> yellowColor];</div><div class="line">&#125;];</div><div class="line"></div><div class="line">RAC(<span class="keyword">self</span>.usernameTextField, backgroundColor) = [validUsernameSignal map:^<span class="keyword">id</span>(<span class="built_in">NSNumber</span> *passwordValid) &#123;</div><div class="line">    <span class="keyword">return</span> [passwordValid boolValue] ? [<span class="built_in">UIColor</span> clearColor] : [<span class="built_in">UIColor</span> yellowColor];</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<p><code>RAC</code>宏我们将信号的输入值指派给对象的属性。它带有两个参数，第一个参数是对象，第二个参数是对象的属性名。每次信号发送下一个事件时，其输出值都会指派给给定的属性。这是个非常优雅的解决方案，对吧？</p>
<p>在运行前，我们先找到<code>updateUIState</code>方法，并注释掉下面两行代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">self</span>.usernameTextField.backgroundColor = <span class="keyword">self</span>.usernameIsValid ? [<span class="built_in">UIColor</span> clearColor] : [<span class="built_in">UIColor</span> yellowColor];</div><div class="line"><span class="keyword">self</span>.passwordTextField.backgroundColor = <span class="keyword">self</span>.passwordIsValid ? [<span class="built_in">UIColor</span> clearColor] : [<span class="built_in">UIColor</span> yellowColor];</div></pre></td></tr></table></figure>
<p>运行程序，我们可以看到当输入无效时文本输入框是高亮的，有效时则清除高亮。在这里，我们可以看到两条带有文本信号的简单的管道，都是将它们映射到标明是否有效的布尔对象，然后再映射到<code>UIColor</code>对象。如下图所示：</p>
<p><img src="http://cdn5.raywenderlich.com/wp-content/uploads/2014/01/TextFieldValidPipeline.png" alt="image"></p>
<h2 id="组合信号"><a href="#组合信号" class="headerlink" title="组合信号"></a>组合信号</h2><p>在当前的程序中，<code>Sign in</code>按钮只有在两个输入框都有效时才可点击。是时候处理这个响应了。</p>
<p>当前代码有两个信号来标识用户名和密码是否有效：<code>validUsernameSignal</code>和<code>validPasswordSignal</code>。我们的任务是要组合这两个信号，来确定按钮是否可用。</p>
<p>在<code>viewDidLoad</code>中添加下面的代码</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">RACSignal *signUpActiveSignal = [RACSignal combineLatest:@[validUsernameSignal, validPasswordSignal]</div><div class="line">                                                  reduce:^<span class="keyword">id</span>(<span class="built_in">NSNumber</span> *usernameValid, <span class="built_in">NSNumber</span> *passwordValid)&#123;</div><div class="line"></div><div class="line">                                                      <span class="keyword">return</span> @([usernameValid boolValue] &amp;&amp; [passwordValid boolValue]);</div><div class="line">                                                  &#125;];</div></pre></td></tr></table></figure>
<p>上面的代码使用了<code>combineLatest:reduce:</code>方法来组合<code>validUsernameSignal</code>与<code>validPasswordSignal</code>最后输出的值，并生成一个新的信号。每次两个源信号中的一个输出新值时，<code>reduce</code>块都会被执行，而返回的值会作为组合信号的下一个值。</p>
<p><em>注意：<code>RACSignal</code>组合方法可以组合任何数量的信号，而<code>reduce</code>块的参数会对应每一个信号。</em></p>
<p>现在我们已以有了一个合适的信号，接着在<code>viewDidLoad</code>结尾中添加以下代码，这将信号连接到按钮的<code>enabled</code>属性。</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[signUpActiveSignal subscribeNext:^(<span class="built_in">NSNumber</span> *signupActive) &#123;</div><div class="line"></div><div class="line">    <span class="keyword">self</span>.signInButton.enabled = [signupActive boolValue];</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<p>同样，在运行前移除以下代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> passwordIsValid;</div><div class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>) <span class="built_in">BOOL</span> usernameIsValid;</div></pre></td></tr></table></figure>
<p>同时移除<code>viewDidLoad</code>中以下代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[<span class="keyword">self</span>.usernameTextField addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(usernameTextFieldChanged) forControlEvents:<span class="built_in">UIControlEventEditingChanged</span>];</div><div class="line">[<span class="keyword">self</span>.passwordTextField addTarget:<span class="keyword">self</span> action:<span class="keyword">@selector</span>(passwordTextFieldChanged) forControlEvents:<span class="built_in">UIControlEventEditingChanged</span>];</div></pre></td></tr></table></figure>
<p>当然我们还需要移除<code>updateUIState</code>, <code>usernameTextFieldChanged</code>和<code>passwordTextFieldChanged</code>方法及相关的调用。瞧，我们已经删除了不少代码了。感谢自己吧！</p>
<p>运行，并检查<code>Sign in</code>按钮。如同之前一下，如果用户名和密码都有效，则按钮是可用的。</p>
<p>更新后程序的逻辑如下图所示：</p>
<p><img src="http://cdn3.raywenderlich.com/wp-content/uploads/2014/01/CombinePipeline.png" alt="image"></p>
<p>上面我们已经用<code>ReactiveCocoa</code>实现了一些非常棒的功能，它包含了两个重要的概念：</p>
<ol>
<li><code>Spliting</code>: 信号可以有多个订阅者，且作为资源服务于序列化管道的多个步骤。</li>
<li><code>Combining</code>: 多个信号可以组合起来创建新的信号。</li>
</ol>
<p>在上面的程序中，这些改变让程序不再需要私有属性，来标明两个输入域的有效状态。这是使用响应式编程的关键区别–我们不需要使用实例变量来跟踪短暂的状态。</p>
<h2 id="响应Sign-in"><a href="#响应Sign-in" class="headerlink" title="响应Sign-in"></a>响应Sign-in</h2><p>程序目前使用了响应式管道来管理输入框与按钮的状态。按钮的点击操作仍然使用<code>target-action</code>。所以，这是我们下一步的目标。</p>
<p>Sign-in按钮的<code>Touch Up Inside</code>事件通过<code>storyboard action</code>连接到<code>RWViewController.m</code>的<code>signInButtonTouched</code>方法中。我们现在使用响应式方法来替换它，所以第一步我们需要解除当前<code>storyboard action</code>的连接。这个自己处理吧。</p>
<p>为了处理按钮事件，我们需要使用<code>ReactiveCocoa</code>添加到<code>UIKit</code>的另一个方法：<code>rac_signalForControlEvents</code>。我们在<code>viewDidLoad</code>结尾加入以下代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[[<span class="keyword">self</span>.signInButton rac_signalForControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>] subscribeNext:^(<span class="keyword">id</span> x) &#123;</div><div class="line"></div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Button clicked"</span>);</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<p>上面的代码从按钮的<code>UIControlEventTouchUpInside</code>事件中创建一个信号，并添加订阅以在每次事件发生时添加日志。</p>
<p>运行程序，当按钮可点时点击按钮，会记录以下日志：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">17</span>:<span class="number">45</span>:<span class="number">43.660</span> RWReactivePlayground[<span class="number">9617</span>:<span class="number">60</span>b] Button clicked</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">17</span>:<span class="number">45</span>:<span class="number">44.493</span> RWReactivePlayground[<span class="number">9617</span>:<span class="number">60</span>b] Button clicked</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">17</span>:<span class="number">45</span>:<span class="number">44.660</span> RWReactivePlayground[<span class="number">9617</span>:<span class="number">60</span>b] Button clicked</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">17</span>:<span class="number">45</span>:<span class="number">44.810</span> RWReactivePlayground[<span class="number">9617</span>:<span class="number">60</span>b] Button clicked</div><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">17</span>:<span class="number">45</span>:<span class="number">44.944</span> RWReactivePlayground[<span class="number">9617</span>:<span class="number">60</span>b] Button clicked</div></pre></td></tr></table></figure>
<p>现在点击事件有一个信号了，接下来将信号与登录处理连接起来。打开<code>RWDummySignInService.h</code>文件，我们会看到下面的接口：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">void</span> (^RWSignInResponse)(<span class="built_in">BOOL</span>);</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">RWDummySignInService</span> : <span class="title">NSObject</span></span></div><div class="line"></div><div class="line">- (<span class="keyword">void</span>)signInWithUsername:(<span class="built_in">NSString</span> *)username password:(<span class="built_in">NSString</span> *)password complete:(RWSignInResponse)completeBlock;</div><div class="line"></div><div class="line"><span class="keyword">@end</span></div></pre></td></tr></table></figure>
<p>这个方法带有一个用户名、密码和一个完成<code>block</code>。<code>block</code>会在登录成功或失败时调用。我们可以在<code>subscribeNext:</code>块中直接调用这个方法，但为什么不呢？因为这是一个异步操作，小心了。</p>
<h2 id="创建信号"><a href="#创建信号" class="headerlink" title="创建信号"></a>创建信号</h2><p>幸运的是，将一个已存在的异步<code>API</code>表示为一个信号相当简单。我们来看看。</p>
<p>首先，从<code>RWViewController.m</code>移除当前的<code>signInButtonTouched:</code>方法。我们通过响应式编程来取代它。</p>
<p>在<code>RWViewController.m</code>中添加以下方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">- (RACSignal *)signInSignal</div><div class="line">&#123;</div><div class="line">    <span class="keyword">return</span> [RACSignal createSignal:^RACDisposable *(<span class="keyword">id</span>&lt;RACSubscriber&gt; subscriber) &#123;</div><div class="line"></div><div class="line">        [<span class="keyword">self</span>.signInService signInWithUsername:<span class="keyword">self</span>.usernameTextField.text</div><div class="line">                                      password:<span class="keyword">self</span>.passwordTextField.text</div><div class="line">                                      complete:^(<span class="built_in">BOOL</span> success) &#123;</div><div class="line">                                          [subscriber sendNext:@(success)];</div><div class="line">                                          [subscriber sendCompleted];</div><div class="line">                                      &#125;];</div><div class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的代码创建了一个使用当前用户名与密码登录的信号。现在我们来分解一下这个方法。<code>createSignal:</code>方法用于创建一个信号。描述信号的<code>block</code>是一个信号参数，当信号有一个订阅者时，<code>block</code>中的代码会被执行。</p>
<p><code>block</code>传递一个实现<code>RACSubscriber</code>协议的<code>subscriber</code>(订阅者)，这个订阅者包含我们调用的用于发送事件的方法；我们也可以发送多个<code>next</code>事件，这些事件由一个<code>error</code>事件或<code>complete</code>事件结束。在上面这种情况下，它发送一个<code>next</code>事件来表示登录是否成功，后续是一个<code>complete</code>事件。</p>
<p>这个<code>block</code>的返回类型是一个<code>RACDisposable</code>对象，它允许我们执行一些清理任务，这些操作可能发生在订阅取消或丢弃时。上面这个这个信号没有任何清理需求，所以返回<code>nil</code>。</p>
<p>可以看到，我们就这样在信号中封装了一个异步<code>API</code>。现在，我们可以使用这个新的信号了，更新<code>viewDidLoad</code>中我们的代码吧：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[[[<span class="keyword">self</span>.signInButton rac_signalForControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>] map:^<span class="keyword">id</span>(<span class="keyword">id</span> value) &#123;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> signInButton];</div><div class="line">&#125;] subscribeNext:^(<span class="keyword">id</span> x) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Sign in result: %@"</span>, x);</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<p>上面的代码使用<code>map</code>方法将按钮点击信号转换为登录信号。订阅者简单输出了结果。</p>
<p>运行程序，点击按钮，可以看到以下输出：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">18</span>:<span class="number">29</span>:<span class="number">27.134</span> RWReactivePlayground[<span class="number">9749</span>:<span class="number">60</span>b] Sign <span class="keyword">in</span> result: &lt;<span class="built_in">UIButton</span>: <span class="number">0x13651ed40</span>; frame = (<span class="number">192</span> <span class="number">201</span>; <span class="number">76</span> <span class="number">30</span>); opaque = <span class="literal">NO</span>; autoresize = RM+BM; layer = &lt;<span class="built_in">CALayer</span>: <span class="number">0x178224c00</span>&gt;&gt;</div></pre></td></tr></table></figure>
<p>可以看到<code>subscribeNext:</code>块传递了一个正确的信号，但结果不是登录信号。我们用图来展示这个管道操作：</p>
<p><img src="http://cdn4.raywenderlich.com/wp-content/uploads/2014/01/SignalOfSignals.png" alt="image"></p>
<p>当点击按钮时<code>rac_signalForControlEvents</code>发出了一个<code>next</code>事件。<code>map</code>这一步创建并返回一个登录信号，意味着接下来的管理接收一个<code>RACSignal</code>。这是我们在<code>subscribeNext:</code>中观察到的对象。</p>
<p>上面这个方案有时候称为信号的信号(<code>signal of signals</code>)，换句话说，就是一个外部信号包含一个内部信号。可以在输出信号的<code>subscribeNext:</code>块中订阅内部信号。但这会引起嵌套的麻烦。幸运的是，这是个普遍的问题，而<code>ReactiveCocoa</code>已经提供了解决方案。</p>
<h2 id="Signal-of-Signals"><a href="#Signal-of-Signals" class="headerlink" title="Signal of Signals"></a>Signal of Signals</h2><p>这个问题有解决方案是直观的，只需要使用<code>flattenMap</code>来替换<code>map</code>。如下代码所示：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[[[<span class="keyword">self</span>.signInButton rac_signalForControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>] flattenMap:^RACStream *(<span class="keyword">id</span> value) &#123;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> signInSignal];</div><div class="line">&#125;] subscribeNext:^(<span class="keyword">id</span> x) &#123;</div><div class="line">    <span class="built_in">NSLog</span>(<span class="string">@"Sign in result: %@"</span>, x);</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<p>这将按钮点击事件映射到一个登录信号，但同时通过将事件从内部信号发送到外部信号，使这个过程变得扁平化。再次运行程序，我们将得到以下的输出</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="number">2014</span><span class="number">-07</span><span class="number">-31</span> <span class="number">18</span>:<span class="number">46</span>:<span class="number">19.535</span> RWReactivePlayground[<span class="number">9785</span>:<span class="number">60</span>b] Sign <span class="keyword">in</span> result: <span class="number">1</span></div></pre></td></tr></table></figure>
<p>这回对了。</p>
<p>现在管道处理得到了我们想要的结果，最后我们在<code>subscriptNext</code>中添加登录处理逻辑。使用以下代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[[[<span class="keyword">self</span>.signInButton rac_signalForControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>] flattenMap:^RACStream *(<span class="keyword">id</span> value) &#123;</div><div class="line">    <span class="keyword">return</span> [<span class="keyword">self</span> signInSignal];</div><div class="line">&#125;] subscribeNext:^(<span class="built_in">NSNumber</span> *signedIn) &#123;</div><div class="line"></div><div class="line">    <span class="built_in">BOOL</span> success = [signedIn boolValue];</div><div class="line">    <span class="keyword">self</span>.signInFailureText.hidden = success;</div><div class="line">    <span class="keyword">if</span> (success)</div><div class="line">    &#123;</div><div class="line">        [<span class="keyword">self</span> performSegueWithIdentifier:<span class="string">@"signInSuccess"</span> sender:<span class="keyword">self</span>];</div><div class="line">    &#125;</div><div class="line">&#125;];</div></pre></td></tr></table></figure>
<p>运行程序，我们就可以得到下面的结果了：</p>
<p><img src="http://cdn4.raywenderlich.com/wp-content/uploads/2014/01/ReactivePlaygroundStarter.jpg" alt="image"></p>
<p>不知道你是否注意到一个细节问题。当点击登录进行验证时，我们应该置灰登录按钮。这样可以阻止用户在验证的过程中再次去点击登录。那么这个逻辑添加在哪呢？改变按钮的可用状态不是个转换、过滤或其它的信号。这就是下一步要讲的。</p>
<h2 id="添加附加操作-side-effects"><a href="#添加附加操作-side-effects" class="headerlink" title="添加附加操作(side-effects)"></a>添加附加操作(side-effects)</h2><p>使用下面的代码替换当前管道：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[[[[<span class="keyword">self</span>.signInButton rac_signalForControlEvents:<span class="built_in">UIControlEventTouchUpInside</span>]</div><div class="line"> doNext:^(<span class="keyword">id</span> x) &#123;</div><div class="line">     <span class="keyword">self</span>.signInButton.enabled = <span class="literal">NO</span>;</div><div class="line">     <span class="keyword">self</span>.signInFailureText.hidden = <span class="literal">YES</span>;</div><div class="line"> &#125;]</div><div class="line"> flattenMap:^RACStream *(<span class="keyword">id</span> value) &#123;</div><div class="line">     <span class="keyword">return</span> [<span class="keyword">self</span> signInSignal];</div><div class="line"> &#125;]</div><div class="line"> subscribeNext:^(<span class="built_in">NSNumber</span> *signedIn) &#123;</div><div class="line">     <span class="keyword">self</span>.signInButton.enabled = <span class="literal">YES</span>;</div><div class="line">     <span class="built_in">BOOL</span> success = [signedIn boolValue];</div><div class="line">     <span class="keyword">self</span>.signInFailureText.hidden = success;</div><div class="line">     <span class="keyword">if</span> (success) &#123;</div><div class="line">         [<span class="keyword">self</span> performSegueWithIdentifier:<span class="string">@"signInSuccess"</span> sender:<span class="keyword">self</span>];</div><div class="line">     &#125;</div><div class="line"> &#125;];</div></pre></td></tr></table></figure>
<p>我们可以看到在按钮点击事件后添加了<code>doNext:</code>步骤。注意<code>doNext:</code>并不返回一个值，因为它是附加操作。它完成时不改变事件。下图展示了这个过程：</p>
<p><img src="http://cdn3.raywenderlich.com/wp-content/uploads/2014/01/SideEffects.png" alt="image"></p>
<p>运行程序看看效果。如何？</p>
<p>注意：在执行异步方法时禁用按钮是个普遍的问题，<code>ReactiveCocoa</code>同样解决了这个问题。<strong>RACCommand</strong>类封装了这个概念，同时有一个<code>enabled</code>信号以允许我们将一个按钮的<code>enabled</code>属性连接到信号。可以试试。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p><code>ReactiveCocoa</code>的核心是信号，它是一个事件流。使用<code>ReactiveCocoa</code>时，对于同一个问题，可能会有多种不同的方法来解决。<code>ReactiveCocoa</code>的目的就是为了简化我们的代码并更容易理解。如果使用一个清晰的管道，我们可以很容易理解问题的处理过程。在下一部分，我们将会讨论错误事件的处理及完成事件的处理。</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2014/08/01/core-bluetooth-programming-guide-3/" rel="next" title="Core Bluetooth框架之三：最佳实践">
                <i class="fa fa-chevron-left"></i> Core Bluetooth框架之三：最佳实践
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2014/08/02/reactivecocoa-tutorial-the-definitive-introduction-2/" rel="prev" title="ReactiveCocoa Tutorial – The Definitive Introduction: Part 2/2">
                ReactiveCocoa Tutorial – The Definitive Introduction: Part 2/2 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="南峰子" />
          <p class="site-author-name" itemprop="name">南峰子</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">82</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Reactive-Playground实例"><span class="nav-number">1.</span> <span class="nav-text">Reactive Playground实例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#添加ReactiveCocoa框架"><span class="nav-number">2.</span> <span class="nav-text">添加ReactiveCocoa框架</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Time-to-Play"><span class="nav-number">3.</span> <span class="nav-text">Time to Play</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#事件是什么"><span class="nav-number">4.</span> <span class="nav-text">事件是什么</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建有效的状态信号"><span class="nav-number">5.</span> <span class="nav-text">创建有效的状态信号</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#组合信号"><span class="nav-number">6.</span> <span class="nav-text">组合信号</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#响应Sign-in"><span class="nav-number">7.</span> <span class="nav-text">响应Sign-in</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建信号"><span class="nav-number">8.</span> <span class="nav-text">创建信号</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Signal-of-Signals"><span class="nav-number">9.</span> <span class="nav-text">Signal of Signals</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#添加附加操作-side-effects"><span class="nav-number">10.</span> <span class="nav-text">添加附加操作(side-effects)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#小结"><span class="nav-number">11.</span> <span class="nav-text">小结</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">南峰子</span>
  <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1000523916'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/z_stat.php%3Fid%3D1000523916%26show%3Dpic1' type='text/javascript'%3E%3C/script%3E"));
  </script>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  




  
  

  

  

  
  

  <div style="display: none;">
    <script src="http://s95.cnzz.com/z_stat.php?id=1000523916&web_id=1000523916" language="JavaScript"></script>
  </div>




</body>
</html>
